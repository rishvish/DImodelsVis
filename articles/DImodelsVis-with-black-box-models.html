<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>DImodelsVis with black-box models • DImodelsVis</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="DImodelsVis with black-box models">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">DImodelsVis</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.3.9001</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item"><a class="nav-link" href="../articles/index.html">Articles</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>DImodelsVis with black-box models</h1>
            
      

      <div class="d-none name"><code>DImodelsVis-with-black-box-models.Rmd</code></div>
    </div>

    
    
<style type="text/css">

/* Highlight box */
.highlightbox {
  background-color: #e6f0fa;   /* light blue */
  border: 2px solid #156082;   /* darker blue */
  border-radius: 6px;
  padding: 10px 14px;
  margin: 12px 0;
  box-shadow: 2px 2px 6px rgba(0,0,0,0.1);
}


/* Note box */
.notebox {
  background-color: #f7f7f7;   /* light gray */
  border: 1px solid #999999;   /* medium gray */
  border-radius: 4px;
  padding: 8px 12px;
  margin: 10px 0;
  box-shadow: 1px 1px 4px rgba(0,0,0,0.08);
}

</style>
<p>This vignette shows an example of how <code>DImodelsVis</code> can be
used to visualise the response surface across the simplex space using
black-box style models such as neural networks or random forests. Note
that, while we show limited examples in this vignetted, it is worth
noting that all visualisations in the package except for model
diagnostics and prediction contributions plots can be created for
black-box style models.</p>
<div class="section level3">
<h3 id="loading-necessary-packages">Loading necessary packages<a class="anchor" aria-label="anchor" href="#loading-necessary-packages"></a>
</h3>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rishvish.github.io/DImodelsVis/">DImodelsVis</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://www.stats.ox.ac.uk/pub/MASS4/" class="external-link">nnet</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://www.stat.berkeley.edu/~breiman/RandomForests/" class="external-link">randomForest</a></span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="data">Data<a class="anchor" aria-label="anchor" href="#data"></a>
</h3>
<p>For this example we simulate a dataset containing 200 soil samples
with varying proportions of sand, silt and clay, constrained to sum to
one. The response variable is soil organic carbon (SOC) and was
simulated to reflect that soils richer in clay have higher SOC, those
with more silt have moderate SOC, and those dominated by sand have lower
SOC.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># For reproducability</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Number of samples</span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">200</span></span>
<span></span>
<span><span class="co"># Simulate 3d compositional data</span></span>
<span><span class="co"># Assume equal density for each variable</span></span>
<span><span class="va">alpha</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/GammaDist.html" class="external-link">rgamma</a></span><span class="op">(</span><span class="va">n</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">alpha</span><span class="op">)</span>, shape <span class="op">=</span> <span class="va">alpha</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">alpha</span><span class="op">)</span>, byrow <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">X</span> <span class="op">&lt;-</span> <span class="va">X</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span>  <span class="co"># normalize to sum to 1</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Sand"</span>, <span class="st">"Silt"</span>, <span class="st">"Clay"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Simulate Soil organic carbon (SOC) to be used as a response</span></span>
<span><span class="co"># We assume, SOC is higher for higher clay content, lower for sand, moderate for silt</span></span>
<span><span class="va">SOC</span> <span class="op">&lt;-</span> <span class="fl">4</span> <span class="op">+</span> <span class="fl">5</span><span class="op">*</span><span class="va">X</span><span class="op">[</span>, <span class="st">"Clay"</span><span class="op">]</span> <span class="op">-</span> <span class="fl">2</span><span class="op">*</span><span class="va">X</span><span class="op">[</span>, <span class="st">"Sand"</span><span class="op">]</span> <span class="op">+</span> <span class="fl">1</span><span class="op">*</span><span class="va">X</span><span class="op">[</span>, <span class="st">"Silt"</span><span class="op">]</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span>, <span class="fl">0</span>, <span class="fl">0.5</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Combine the compositional predictors and continuous response into data frame</span></span>
<span><span class="va">soil_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">X</span>, <span class="va">SOC</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Snippet of data</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">soil_data</span><span class="op">)</span></span>
<span><span class="co">#&gt;         Sand       Silt       Clay      SOC</span></span>
<span><span class="co">#&gt; 1 0.05207917 0.48465979 0.46326105 6.418575</span></span>
<span><span class="co">#&gt; 2 0.40839428 0.14664048 0.44496524 5.772358</span></span>
<span><span class="co">#&gt; 3 0.70241947 0.17418870 0.12339183 3.876166</span></span>
<span><span class="co">#&gt; 4 0.02781371 0.76193153 0.21025476 5.958198</span></span>
<span><span class="co">#&gt; 5 0.14917454 0.06014499 0.79068047 7.389891</span></span>
<span><span class="co">#&gt; 6 0.38854192 0.59306319 0.01839489 4.266738</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="visualising-raw-data">Visualising raw data<a class="anchor" aria-label="anchor" href="#visualising-raw-data"></a>
</h3>
<p>We create a ternary diagram using the <code>tenrary_plot()</code>
function showing the spread of data across the 3d simplex space. The
points are coloured by SOC values, with higher values colour green and
lower values given shades of pink and white.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/ternary_plot.html">ternary_plot</a></span><span class="op">(</span></span>
<span>  <span class="co"># Compositional variables</span></span>
<span>  prop <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Sand"</span>, <span class="st">"Silt"</span>, <span class="st">"Clay"</span><span class="op">)</span>,</span>
<span>  <span class="co"># Labels for ternary axes</span></span>
<span>  tern_labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Sand"</span>, <span class="st">"Silt"</span>, <span class="st">"Clay"</span><span class="op">)</span>,</span>
<span>  <span class="co"># Data with compositional variables </span></span>
<span>  data <span class="op">=</span> <span class="va">soil_data</span>, </span>
<span>  <span class="co"># Show raw data as points instead of a contour map</span></span>
<span>  show <span class="op">=</span> <span class="st">"points"</span>,</span>
<span>  <span class="co"># Colour points by SOC variable</span></span>
<span>  col_var <span class="op">=</span> <span class="st">"SOC"</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Created plot.</span></span></code></pre></div>
<p><img src="DImodelsVis-with-black-box-models_files/figure-html/raw_data-1.png" alt="Plot of raw data in ternary" width="480" style="display: block; margin: auto;"></p>
</div>
<div class="section level3">
<h3 id="neural-network">Neural network<a class="anchor" aria-label="anchor" href="#neural-network"></a>
</h3>
<p>We fit a basic neural network containing a single hidden layer with
seven nodes to the soil data using the proportions of sand, silt, and
clay as predictors. Additional parameters such as <code>decay</code>,
<code>linout</code>, <code>maxit</code> are set (explained in code) at
specific values to ensure predictions are consistent across successive
runs of the neural network.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Seed to ensure weight initialisation is reproducible</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">737</span><span class="op">)</span></span>
<span></span>
<span><span class="va">nn_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nnet/man/nnet.html" class="external-link">nnet</a></span><span class="op">(</span><span class="va">SOC</span> <span class="op">~</span> <span class="va">Sand</span> <span class="op">+</span> <span class="va">Silt</span> <span class="op">+</span> <span class="va">Clay</span>,</span>
<span>                 data <span class="op">=</span> <span class="va">soil_data</span>, </span>
<span>                 size <span class="op">=</span> <span class="fl">7</span>,            <span class="co"># Seven nodes in hidden layer</span></span>
<span>                 decay <span class="op">=</span> <span class="fl">0.01</span>,        <span class="co"># Parameter for weight decay (helps stabilise predictions)</span></span>
<span>                 linout <span class="op">=</span> <span class="cn">TRUE</span>,       <span class="co"># Boolean to indicate continuous predictions</span></span>
<span>                 maxit <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span>        <span class="co"># Number of iterations</span></span>
<span><span class="co">#&gt; # weights:  36</span></span>
<span><span class="co">#&gt; initial  value 5889.515493 </span></span>
<span><span class="co">#&gt; iter  10 value 92.408488</span></span>
<span><span class="co">#&gt; iter  20 value 59.759351</span></span>
<span><span class="co">#&gt; iter  30 value 55.918516</span></span>
<span><span class="co">#&gt; iter  40 value 55.340256</span></span>
<span><span class="co">#&gt; iter  50 value 54.565252</span></span>
<span><span class="co">#&gt; iter  60 value 54.080642</span></span>
<span><span class="co">#&gt; iter  70 value 54.008865</span></span>
<span><span class="co">#&gt; iter  80 value 53.986853</span></span>
<span><span class="co">#&gt; iter  90 value 53.836320</span></span>
<span><span class="co">#&gt; iter 100 value 53.795719</span></span>
<span><span class="co">#&gt; iter 110 value 53.792304</span></span>
<span><span class="co">#&gt; iter 120 value 53.791058</span></span>
<span><span class="co">#&gt; iter 130 value 53.790159</span></span>
<span><span class="co">#&gt; iter 140 value 53.790024</span></span>
<span><span class="co">#&gt; iter 150 value 53.789949</span></span>
<span><span class="co">#&gt; final  value 53.789940 </span></span>
<span><span class="co">#&gt; converged</span></span>
<span><span class="va">nn_model</span></span>
<span><span class="co">#&gt; a 3-7-1 network with 36 weights</span></span>
<span><span class="co">#&gt; inputs: Sand Silt Clay </span></span>
<span><span class="co">#&gt; output(s): SOC </span></span>
<span><span class="co">#&gt; options were - linear output units  decay=0.01</span></span></code></pre></div>
<p><br></p>
<div class="section level4">
<h4 id="visualise-response-surface-across-ternary">Visualise response surface across ternary<a class="anchor" aria-label="anchor" href="#visualise-response-surface-across-ternary"></a>
</h4>
<p>The predicted SOC surface across the 3d simplex space is visualised
here. We first generated the grid of points across the simplex space
using the <code><a href="../reference/ternary_data.html">ternary_data()</a></code> function and then use the neural
network to predict the SOC. The data.frame containing the grid of points
and corresponding predicted SOC is then passed to the
<code><a href="../reference/ternary_plot.html">ternary_plot()</a></code> function for visualising the response
surface.</p>
<div class="notebox">
<p>While we set the <code>prediction = FALSE</code> argument here and
add the predictions at a later step using the
<code><a href="../reference/add_prediction.html">add_prediction()</a></code> function from <code>DImodelsVis</code>.
Users can also use the base R <code><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict()</a></code> function or any
custom function of their choice which returns the predicted response
from a black-box model.</p>
</div>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Prepare data</span></span>
<span><span class="va">ternary_grid</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ternary_data.html">ternary_data</a></span><span class="op">(</span><span class="co"># Compositional predictors</span></span>
<span>                             prop <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Sand"</span>, <span class="st">"Silt"</span>, <span class="st">"Clay"</span><span class="op">)</span>,   </span>
<span>                             <span class="co"># Don't make predictions now and only return template</span></span>
<span>                             prediction <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> </span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">ternary_grid</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Sand      Silt        Clay          .x .y</span></span>
<span><span class="co">#&gt; 1    0 1.0000000 0.000000000 0.000000000  0</span></span>
<span><span class="co">#&gt; 2    0 0.9983306 0.001669449 0.001669449  0</span></span>
<span><span class="co">#&gt; 3    0 0.9966611 0.003338898 0.003338898  0</span></span>
<span><span class="co">#&gt; 4    0 0.9949917 0.005008347 0.005008347  0</span></span>
<span><span class="co">#&gt; 5    0 0.9933222 0.006677796 0.006677796  0</span></span>
<span><span class="co">#&gt; 6    0 0.9916528 0.008347245 0.008347245  0</span></span></code></pre></div>
<p>The predicted response from the neural network can now be added to
the data template created by the <code><a href="../reference/ternary_data.html">ternary_data()</a></code>
function.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Add the predicted response to data</span></span>
<span><span class="va">plot_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/add_prediction.html">add_prediction</a></span><span class="op">(</span><span class="co"># Grid data from ternary_data() function</span></span>
<span>                            data <span class="op">=</span> <span class="va">ternary_grid</span>,</span>
<span>                            <span class="co"># Model to use for making predictions</span></span>
<span>                            model <span class="op">=</span> <span class="va">nn_model</span>,</span>
<span>                            <span class="co"># No uncertainty interval added to data</span></span>
<span>                            interval <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># The predicted response is added as a column called .Pred</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">plot_data</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Sand      Silt        Clay          .x .y    .Pred</span></span>
<span><span class="co">#&gt; 1    0 1.0000000 0.000000000 0.000000000  0 5.065849</span></span>
<span><span class="co">#&gt; 2    0 0.9983306 0.001669449 0.001669449  0 5.070338</span></span>
<span><span class="co">#&gt; 3    0 0.9966611 0.003338898 0.003338898  0 5.074839</span></span>
<span><span class="co">#&gt; 4    0 0.9949917 0.005008347 0.005008347  0 5.079352</span></span>
<span><span class="co">#&gt; 5    0 0.9933222 0.006677796 0.006677796  0 5.083876</span></span>
<span><span class="co">#&gt; 6    0 0.9916528 0.008347245 0.008347245  0 5.088413</span></span></code></pre></div>
<p>The response surface can be visualised as follows</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create ternary plot</span></span>
<span><span class="fu"><a href="../reference/ternary_plot.html">ternary_plot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">plot_data</span>,      <span class="co"># Compositional data with predicted response</span></span>
<span>             lower_lim <span class="op">=</span> <span class="fl">1.5</span>,       <span class="co"># Lower limit of fill scale</span></span>
<span>             upper_lim <span class="op">=</span> <span class="fl">9.5</span>,       <span class="co"># Upper limit of fill scale</span></span>
<span>             nlevels <span class="op">=</span> <span class="fl">8</span>,           <span class="co"># Number of colours for fill scale</span></span>
<span>             <span class="co"># Labels for ternary axes</span></span>
<span>             tern_labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Sand"</span>, <span class="st">"Silt"</span>, <span class="st">"Clay"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># ggplot function to add labels on plot</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"Predicted\nSOC"</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Created plot.</span></span></code></pre></div>
<p><img src="DImodelsVis-with-black-box-models_files/figure-html/visualise_nn_model-1.png" alt="Ternary diagram showing SOC" width="480" style="display: block; margin: auto;"></p>
<p>The predicted SOC is higher in soil containing high proportions of
clay and lower in soil containing high amounts of sand.</p>
<p><br></p>
</div>
<div class="section level4">
<h4 id="effects-plots-for-the-compositional-predictors">Effects plots for the compositional predictors<a class="anchor" aria-label="anchor" href="#effects-plots-for-the-compositional-predictors"></a>
</h4>
<p>We can also generate effects plots for the compositional predictors
in the neural network. First, the dataset needed for generating the
effects plot is created using the <code><a href="../reference/visualise_effects_data.html">visualise_effects_data()</a></code>
function. The predicted SOC is then added to the data using the
<code><a href="../reference/add_prediction.html">add_prediction()</a></code> function and the prepared data is passed
onto the <code><a href="../reference/visualise_effects_plot.html">visualise_effects_plot()</a></code> function for visualising
the effects.</p>
<div class="notebox">
<p>Users could also set <code>prediction = TRUE</code> and have the
predictions added to the data in the data preparation step itself, as
shown in the random-forest example later in the vignette.</p>
</div>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Compositions to be used for generating the effects plots.</span></span>
<span><span class="co"># Not all are needed but having more initial compositions gives higher accuracy. </span></span>
<span><span class="va">eff_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html" class="external-link">tribble</a></span><span class="op">(</span><span class="op">~</span><span class="st">"Sand"</span>, <span class="op">~</span><span class="st">"Silt"</span>, <span class="op">~</span><span class="st">"Clay"</span>,</span>
<span>                          <span class="fl">1</span>,       <span class="fl">0</span>,       <span class="fl">0</span>, </span>
<span>                          <span class="fl">0</span>,       <span class="fl">1</span>,       <span class="fl">0</span>, </span>
<span>                          <span class="fl">0</span>,       <span class="fl">0</span>,       <span class="fl">1</span>, </span>
<span>                        <span class="fl">0.5</span>,     <span class="fl">0.5</span>,       <span class="fl">0</span>, </span>
<span>                        <span class="fl">0.5</span>,       <span class="fl">0</span>,     <span class="fl">0.5</span>, </span>
<span>                          <span class="fl">0</span>,     <span class="fl">0.5</span>,     <span class="fl">0.5</span>, </span>
<span>                        <span class="fl">0.8</span>,     <span class="fl">0.2</span>,       <span class="fl">0</span>,</span>
<span>                        <span class="fl">0.2</span>,     <span class="fl">0.8</span>,       <span class="fl">0</span>,</span>
<span>                        <span class="fl">0.8</span>,       <span class="fl">0</span>,     <span class="fl">0.2</span>, </span>
<span>                        <span class="fl">0.2</span>,       <span class="fl">0</span>,     <span class="fl">0.8</span>,</span>
<span>                          <span class="fl">0</span>,     <span class="fl">0.8</span>,     <span class="fl">0.2</span>, </span>
<span>                          <span class="fl">0</span>,     <span class="fl">0.2</span>,     <span class="fl">0.8</span>,</span>
<span>                        <span class="fl">0.6</span>,     <span class="fl">0.2</span>,     <span class="fl">0.2</span>,</span>
<span>                        <span class="fl">0.2</span>,     <span class="fl">0.6</span>,     <span class="fl">0.2</span>,</span>
<span>                        <span class="fl">0.2</span>,     <span class="fl">0.2</span>,     <span class="fl">0.6</span>,</span>
<span>                        <span class="fl">1</span><span class="op">/</span><span class="fl">3</span>,     <span class="fl">1</span><span class="op">/</span><span class="fl">3</span>,     <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># The data-preparation, adding predictions and plotting are done in a single dplyr pipeline here</span></span>
<span><span class="co"># Prepare data</span></span>
<span><span class="fu"><a href="../reference/visualise_effects_data.html">visualise_effects_data</a></span><span class="op">(</span><span class="co"># Data with initial compostions</span></span>
<span>                       data <span class="op">=</span> <span class="va">eff_data</span>,</span>
<span>                       <span class="co"># Column names for compositional predictors in data</span></span>
<span>                       prop <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Sand"</span>, <span class="st">"Silt"</span>, <span class="st">"Clay"</span><span class="op">)</span>,</span>
<span>                       <span class="co"># Show effects plot for all compostional variables</span></span>
<span>                       var_interest <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Sand"</span>, <span class="st">"Silt"</span>, <span class="st">"Clay"</span><span class="op">)</span>,</span>
<span>                       <span class="co"># Don't make predictions now and only return template</span></span>
<span>                       prediction <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="co"># Add predictions</span></span>
<span>  <span class="fu"><a href="../reference/add_prediction.html">add_prediction</a></span><span class="op">(</span>interval <span class="op">=</span> <span class="st">"none"</span>,        <span class="co"># No uncertainty intervals</span></span>
<span>                 model <span class="op">=</span> <span class="va">nn_model</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>     <span class="co"># Model to use for making predictions </span></span>
<span>  <span class="co"># Print first few rows of data</span></span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">6</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>  </span>
<span>  <span class="co"># Create plot</span></span>
<span>  <span class="fu"><a href="../reference/visualise_effects_plot.html">visualise_effects_plot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="co"># ggplot function to add labels on plot</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="st">"Predicted SOC"</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Finished data preparation.</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 4,545 × 8</span></span></span>
<span><span class="co">#&gt;    Sand  Silt  Clay .Sp   .Proportion .Group .Effect  .Pred</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>  0     1        0 Sand         0         1 increase  5.07</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span>  0.01  0.99     0 Sand         0.01      1 increase  5.03</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span>  0.02  0.98     0 Sand         0.02      1 increase  5.00</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span>  0.03  0.97     0 Sand         0.03      1 increase  4.97</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span>  0.04  0.96     0 Sand         0.04      1 increase  4.94</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span>  0.05  0.95     0 Sand         0.05      1 increase  4.91</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 4,539 more rows</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Created plot.</span></span></code></pre></div>
<p><img src="DImodelsVis-with-black-box-models_files/figure-html/nn_model_effects-1.png" alt="Effects plot for compositional predictors" width="864" style="display: block; margin: auto;"></p>
<p>Increasing the proportion of sand lowers SOC, while increasing clay
raises it. The effect of silt depends on the soil context: it tends to
increase SOC in sand-rich soils but reduce it in clay-rich soils,
leading to an overall flat effect of silt on SOC.</p>
</div>
</div>
<div class="section level3">
<h3 id="random-forest-model">Random forest model<a class="anchor" aria-label="anchor" href="#random-forest-model"></a>
</h3>
<p>We also show an example of using <code>DImodelsVis</code> with random
forest models. The same pipeline as depicted above can be used with
random forest models to create visualisations from
<code>DImodelsVis</code>.</p>
<p>We first a random forest model using the proportions of sand, silt,
and clay as well as their pairwise interactions as predictors.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">forest_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/randomForest/man/randomForest.html" class="external-link">randomForest</a></span><span class="op">(</span><span class="co"># Predictor for random forest model</span></span>
<span>                             <span class="va">SOC</span> <span class="op">~</span> <span class="va">Sand</span> <span class="op">+</span> <span class="va">Silt</span> <span class="op">+</span> <span class="va">Clay</span> <span class="op">+</span> </span>
<span>                               <span class="va">Sand</span><span class="op">:</span><span class="va">Silt</span> <span class="op">+</span> <span class="va">Silt</span><span class="op">:</span><span class="va">Clay</span> <span class="op">+</span> <span class="va">Sand</span><span class="op">:</span><span class="va">Clay</span>,</span>
<span>                             <span class="co"># Data</span></span>
<span>                             data <span class="op">=</span> <span class="va">soil_data</span>, </span>
<span>                             <span class="co"># 5000 trees to be used random forest</span></span>
<span>                             ntree <span class="op">=</span> <span class="fl">5000</span><span class="op">)</span></span>
<span><span class="va">forest_model</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt;  randomForest(formula = SOC ~ Sand + Silt + Clay + Sand:Silt +      Silt:Clay + Sand:Clay, data = soil_data, ntree = 5000) </span></span>
<span><span class="co">#&gt;                Type of random forest: regression</span></span>
<span><span class="co">#&gt;                      Number of trees: 5000</span></span>
<span><span class="co">#&gt; No. of variables tried at each split: 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;           Mean of squared residuals: 0.3552504</span></span>
<span><span class="co">#&gt;                     % Var explained: 82.15</span></span></code></pre></div>
<p><br></p>
<div class="section level4">
<h4 id="response-surface-across-ternary-using-random-forests">Response surface across ternary using random forests<a class="anchor" aria-label="anchor" href="#response-surface-across-ternary-using-random-forests"></a>
</h4>
<p>Similar to above, we could visualise the predicted response surface
for SOC across the three dimensional simplex space using a ternary
diagram. For this example, we also showcase the use of setting
<code>prediction = TRUE</code> in the <code><a href="../reference/ternary_data.html">ternary_data()</a></code>
function to automatically add predictions to created grid of points for
the ternary diagram. This prepared data is then passed to the
<code><a href="../reference/ternary_plot.html">ternary_plot()</a></code> function to visualise the response
surface.</p>
<div class="notebox">
<p>The <code>prediction = TRUE</code> argument can be specified in any
of the data preparation functions in the package to automatically add
predictions to the prepared data. However, when working with complex
models with multiple predictions, care should be taken as users may wish
to supply values for these predictors other than the function’s
defaults.</p>
</div>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Prepare data</span></span>
<span><span class="fu"><a href="../reference/ternary_data.html">ternary_data</a></span><span class="op">(</span><span class="co"># Names of compositional predictors</span></span>
<span>             prop <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Sand"</span>, <span class="st">"Silt"</span>, <span class="st">"Clay"</span><span class="op">)</span>, </span>
<span>             <span class="co"># Model to use for making predictions</span></span>
<span>             model <span class="op">=</span> <span class="va">forest_model</span>,</span>
<span>             <span class="co"># Add predictions directly</span></span>
<span>             prediction <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="../reference/ternary_plot.html">ternary_plot</a></span><span class="op">(</span>lower_lim <span class="op">=</span> <span class="fl">1.5</span>,       <span class="co"># Lower limit of fill scale</span></span>
<span>             upper_lim <span class="op">=</span> <span class="fl">9.5</span>,       <span class="co"># Upper limit of fill scale</span></span>
<span>             nlevels <span class="op">=</span> <span class="fl">8</span>,           <span class="co"># Number of colours for fill scale</span></span>
<span>             <span class="co"># Labels for ternary axes</span></span>
<span>             tern_labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Sand"</span>, <span class="st">"Silt"</span>, <span class="st">"Clay"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># ggplot function to add labels on plot</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"Predicted\nSOC"</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Created plot.</span></span></code></pre></div>
<p><img src="DImodelsVis-with-black-box-models_files/figure-html/visualise_forest_model-1.png" alt="Response surface from random forest" width="480" style="display: block; margin: auto;"></p>
<p>A similar inference can be drawn as the neural network: predicted SOC
is higher in soils with greater clay content and lower in those with
higher sand content. However, the predicted response surface is
noticeably more jagged for a random forest compared to a neural network
or standard linear regression model. This could be improved by either
fine tuning the model parameters further or by applying a
post-processing smoothing operation over the predicted values.</p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Rishabh Vishwakarma, Caroline Brophy, Laura Byrne, Catherine Hurley.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
